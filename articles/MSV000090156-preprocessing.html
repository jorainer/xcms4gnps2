<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>xcms-based preprocessing of LC-MS/MS data for feature-based molecular networking with GNPS2 • xcms4gnps2</title>
<script src="../lightswitch.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="MSV000090156-preprocessing_files/libs/quarto-html/popper.min.js"></script><script src="MSV000090156-preprocessing_files/libs/quarto-html/tippy.umd.min.js"></script><link href="MSV000090156-preprocessing_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="MSV000090156-preprocessing_files/libs/quarto-html/light-border.css" rel="stylesheet">
<!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="xcms-based preprocessing of LC-MS/MS data for feature-based molecular networking with GNPS2">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top " aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">xcms4gnps2</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.99.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/MSV000090156-preprocessing.html">xcms-based preprocessing of LC-MS/MS data for feature-based molecular networking with GNPS2</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/jorainer/xcms4gnps2/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-lightswitch" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true" aria-label="Light switch"><span class="fa fa-sun"></span></button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-lightswitch">
<li><button class="dropdown-item" data-bs-theme-value="light"><span class="fa fa-sun"></span> Light</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="dark"><span class="fa fa-moon"></span> Dark</button></li>
    <li><button class="dropdown-item" data-bs-theme-value="auto"><span class="fa fa-adjust"></span> Auto</button></li>
  </ul>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-quarto">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>xcms-based preprocessing of LC-MS/MS data for feature-based molecular networking with GNPS2</h1>

      <p class="author">Philippine Louail, Steffen Neumann, Johannes Rainer</p>


      <small class="dont-index">Source: <a href="https://github.com/jorainer/xcms4gnps2/blob/main/vignettes/MSV000090156-preprocessing.qmd" class="external-link"><code>vignettes/MSV000090156-preprocessing.qmd</code></a></small>
      <div class="d-none name"><code></code></div>
    </div>






    <section class="section level2"><h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This document describes data inspection and preprocessing of an LC-MS/MS data set using <em>xcms</em> <span class="citation" data-cites="louail_xcms_2025">(<a href="#ref-louail_xcms_2025" role="doc-biblioref">Louail, Brunius, et al. 2025</a>)</span> and export of the data for subsequent feature-based molecular networking (FBMN) with GNPS2. Functionality from different packages from the RforMassSpectrometry package ecosystem are combined to visualize and process the data.</p>
<p>For details and more in depth description of the various visualizations and analysis options as well as parameter choices see also the <a href="https://rformassspectrometry.github.io/Metabonaut" class="external-link">Metabonaut</a> tutorials <span class="citation" data-cites="louail_rformassspectrometrymetabonaut_2025">(<a href="#ref-louail_rformassspectrometrymetabonaut_2025" role="doc-biblioref">Louail, Graeve, et al. 2025</a>)</span>.</p>
<p>This analysis and the used settings should be considered <em>initial</em> with potential refinement and improvement based on discussions expected during integration of the analysis into the FBMS workflow.</p>
</section><section class="section level2"><h2 id="required-software-packages">Required software packages<a class="anchor" aria-label="anchor" href="#required-software-packages"></a>
</h2>
<p>The various software packages required for the analysis are defined and loaded below. All packages are available through Bioconductor or CRAN and can be installed with <code>BiocManager::install(&lt;package name&gt;)</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/MsExperiment" class="external-link">MsExperiment</a></span><span class="op">)</span> <span class="co"># container for MS data</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/Spectra" class="external-link">Spectra</a></span><span class="op">)</span>      <span class="co"># main MS infrastructure for R</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/sneumann/xcms" class="external-link">xcms</a></span><span class="op">)</span>         <span class="co"># for preprocessing of LC-MS and LC-MS/MS data</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RforMassSpectrometry/MsBackendMgf" class="external-link">MsBackendMgf</a></span><span class="op">)</span> <span class="co"># to export MS data in MGF format</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">RColorBrewer</span><span class="op">)</span> <span class="co"># to define colors</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://rapporter.github.io/pander/" class="external-link">pander</a></span><span class="op">)</span>       <span class="co"># to format tables</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">pheatmap</span><span class="op">)</span>     <span class="co"># visualization of clustering results as heatmap</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/TomKellyGenetics/vioplot" class="external-link">vioplot</a></span><span class="op">)</span>      <span class="co"># to create *violin plots*</span></span></code></pre></div>
</div>
</section><section class="section level2"><h2 id="data-import">Data import<a class="anchor" aria-label="anchor" href="#data-import"></a>
</h2>
<p>The data analyzed here is part of the MassIVE <a href="https://massive.ucsd.edu/ProteoSAFe/dataset.jsp?task=06bd49807caa4390961fb827606a8696" class="external-link">MSV000090156</a> data set. The full data set (raw data files) should first downloaded from the respective directory of the ftp server: <a href="ftp://massive-ftp.ucsd.edu/v04/MSV000090156/">ftp://massive-ftp.ucsd.edu/v04/MSV000090156/</a>. Here we will analyze the data from <em>Lab 2</em>. Before loading the data we define a <code>data.frame</code> with sample and experiment-specific information for the individual MS runs/data files. These should ideally comprise all relevant phenotypic but also technical information (e.g. injection index) to allow proper adjusting or modeling of the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    file_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Interlab-LC-MS_Lab2_A15M_Pos_MS2_Rep1.mzML"</span>,</span>
<span>                  <span class="st">"Interlab-LC-MS_Lab2_A15M_Pos_MS2_Rep2.mzML"</span>,</span>
<span>                  <span class="st">"Interlab-LC-MS_Lab2_A15M_Pos_MS2_Rep3.mzML"</span>,</span>
<span>                  <span class="st">"Interlab-LC-MS_Lab2_A45M_Pos_MS2_Rep1.mzML"</span>,</span>
<span>                  <span class="st">"Interlab-LC-MS_Lab2_A45M_Pos_MS2_Rep2.mzML"</span>,</span>
<span>                  <span class="st">"Interlab-LC-MS_Lab2_A45M_Pos_MS2_Rep3.mzML"</span>,</span>
<span>                  <span class="st">"Interlab-LC-MS_Lab2_A5M_Pos_MS2_Rep1.mzML"</span>,</span>
<span>                  <span class="st">"Interlab-LC-MS_Lab2_A5M_Pos_MS2_Rep2.mzML"</span>,</span>
<span>                  <span class="st">"Interlab-LC-MS_Lab2_A5M_Pos_MS2_Rep3.mzML"</span>,</span>
<span>                  <span class="st">"Interlab-LC-MS_Lab2_M_Pos_MS2_Rep1.mzML"</span>,</span>
<span>                  <span class="st">"Interlab-LC-MS_Lab2_M_Pos_MS2_Rep2.mzML"</span>,</span>
<span>                  <span class="st">"Interlab-LC-MS_Lab2_M_Pos_MS2_Rep3.mzML"</span>,</span>
<span>                  <span class="st">"Interlab-LC-MS_Lab2_PPL_Pos_MS2_Rep1.mzML"</span><span class="op">)</span>,</span>
<span>    sample_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A15M"</span>, <span class="st">"A15M"</span>, <span class="st">"A15M"</span>,</span>
<span>                    <span class="st">"A45M"</span>, <span class="st">"A45M"</span>, <span class="st">"A45M"</span>,</span>
<span>                    <span class="st">"A5M"</span>, <span class="st">"A5M"</span>, <span class="st">"A5M"</span>,</span>
<span>                    <span class="st">"M"</span>, <span class="st">"M"</span>, <span class="st">"M"</span>,</span>
<span>                    <span class="st">"PPL"</span><span class="op">)</span>,</span>
<span>    sample_desc <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A15M_R1"</span>, <span class="st">"A15M_R2"</span>, <span class="st">"A15M_R3"</span>,</span>
<span>                    <span class="st">"A45M_R1"</span>, <span class="st">"A45M_R2"</span>, <span class="st">"A45M_R3"</span>,</span>
<span>                    <span class="st">"A5M_R1"</span>, <span class="st">"A5M_R2"</span>, <span class="st">"A5M_R3"</span>,</span>
<span>                    <span class="st">"M_R1"</span>, <span class="st">"M_R2"</span>, <span class="st">"M_R3"</span>,</span>
<span>                    <span class="st">"PPL_R1"</span><span class="op">)</span>,</span>
<span>    replicate <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<p>To run this analysis the MS data files (in mzML format) above need to be available. In the example workflow, they were downloaded from the MassIVE ftp server and stored to a local folder <em>/data/massive-ftp.ucsd.edu/v04</em>. Below we define the path to the data files and load the data set. This needs to be adapted if the files were stored to a different folder.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="st">"/data"</span>, <span class="st">"massive-ftp.ucsd.edu"</span>, <span class="st">"v04"</span>,</span>
<span>                  <span class="st">"MSV000090156"</span>, <span class="st">"peak"</span>, <span class="st">"mzml"</span>, <span class="st">"POS_MSMS"</span>,</span>
<span>                  <span class="st">"Lab_2"</span><span class="op">)</span></span>
<span><span class="va">mse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MsExperiment/man/readMsExperiment.html" class="external-link">readMsExperiment</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">path</span>, <span class="va">pd</span><span class="op">$</span><span class="va">file_name</span><span class="op">)</span>,</span>
<span>                        sampleData <span class="op">=</span> <span class="va">pd</span><span class="op">)</span></span>
<span><span class="va">mse</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Object of class MsExperiment
 Spectra: MS1 (16302) MS2 (49500)
 Experiment data: 13 sample(s)
 Sample data links:
  - spectra: 13 sample(s) to 65802 element(s).</code></pre>
</div>
</div>
<p>The samples and data files from the present data set are displayed in the table below. Note that in the R code block below we use the R <em>pipe</em> operator <code>|&gt;</code> to avoid nested function calls and improve the readability of the code.</p>
<div class="sourceCode cell-code" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/MsExperiment/man/MsExperiment.html" class="external-link">sampleData</a></span><span class="op">(</span><span class="va">mse</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sample_name"</span>, <span class="st">"sample_desc"</span>, <span class="st">"replicate"</span><span class="op">)</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/pander/man/pandoc.table.return.html" class="external-link">pandoc.table</a></span><span class="op">(</span>style <span class="op">=</span> <span class="st">"rmarkdown"</span>, split.table <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span></span></code></pre></div>
<table class="table caption-top">
<colgroup>
<col style="width: 56%">
<col style="width: 15%">
<col style="width: 15%">
<col style="width: 12%">
</colgroup>
<thead><tr class="header">
<th style="text-align: center;"> </th>
<th style="text-align: center;">sample_name</th>
<th style="text-align: center;">sample_desc</th>
<th style="text-align: center;">replicate</th>
</tr></thead>
<tbody>
<tr class="odd">
<td style="text-align: center;"><strong>Interlab-LC-MS_Lab2_A15M_Pos_MS2_Rep1.mzML</strong></td>
<td style="text-align: center;">A15M</td>
<td style="text-align: center;">A15M_R1</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>Interlab-LC-MS_Lab2_A15M_Pos_MS2_Rep2.mzML</strong></td>
<td style="text-align: center;">A15M</td>
<td style="text-align: center;">A15M_R2</td>
<td style="text-align: center;">2</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>Interlab-LC-MS_Lab2_A15M_Pos_MS2_Rep3.mzML</strong></td>
<td style="text-align: center;">A15M</td>
<td style="text-align: center;">A15M_R3</td>
<td style="text-align: center;">3</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>Interlab-LC-MS_Lab2_A45M_Pos_MS2_Rep1.mzML</strong></td>
<td style="text-align: center;">A45M</td>
<td style="text-align: center;">A45M_R1</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>Interlab-LC-MS_Lab2_A45M_Pos_MS2_Rep2.mzML</strong></td>
<td style="text-align: center;">A45M</td>
<td style="text-align: center;">A45M_R2</td>
<td style="text-align: center;">2</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>Interlab-LC-MS_Lab2_A45M_Pos_MS2_Rep3.mzML</strong></td>
<td style="text-align: center;">A45M</td>
<td style="text-align: center;">A45M_R3</td>
<td style="text-align: center;">3</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>Interlab-LC-MS_Lab2_A5M_Pos_MS2_Rep1.mzML</strong></td>
<td style="text-align: center;">A5M</td>
<td style="text-align: center;">A5M_R1</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>Interlab-LC-MS_Lab2_A5M_Pos_MS2_Rep2.mzML</strong></td>
<td style="text-align: center;">A5M</td>
<td style="text-align: center;">A5M_R2</td>
<td style="text-align: center;">2</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>Interlab-LC-MS_Lab2_A5M_Pos_MS2_Rep3.mzML</strong></td>
<td style="text-align: center;">A5M</td>
<td style="text-align: center;">A5M_R3</td>
<td style="text-align: center;">3</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>Interlab-LC-MS_Lab2_M_Pos_MS2_Rep1.mzML</strong></td>
<td style="text-align: center;">M</td>
<td style="text-align: center;">M_R1</td>
<td style="text-align: center;">1</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>Interlab-LC-MS_Lab2_M_Pos_MS2_Rep2.mzML</strong></td>
<td style="text-align: center;">M</td>
<td style="text-align: center;">M_R2</td>
<td style="text-align: center;">2</td>
</tr>
<tr class="even">
<td style="text-align: center;"><strong>Interlab-LC-MS_Lab2_M_Pos_MS2_Rep3.mzML</strong></td>
<td style="text-align: center;">M</td>
<td style="text-align: center;">M_R3</td>
<td style="text-align: center;">3</td>
</tr>
<tr class="odd">
<td style="text-align: center;"><strong>Interlab-LC-MS_Lab2_PPL_Pos_MS2_Rep1.mzML</strong></td>
<td style="text-align: center;">PPL</td>
<td style="text-align: center;">PPL_R1</td>
<td style="text-align: center;">1</td>
</tr>
</tbody>
</table>
<p>We in addition also define different colors for the individual samples.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Define a color for each unique original sample</span></span>
<span><span class="va">col</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MsExperiment/man/MsExperiment.html" class="external-link">sampleData</a></span><span class="op">(</span><span class="va">mse</span><span class="op">)</span><span class="op">$</span><span class="va">sample_name</span> <span class="op">|&gt;</span></span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>                     <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>                     <span class="fu"><a href="https://rdrr.io/pkg/RColorBrewer/man/ColorBrewer.html" class="external-link">brewer.pal</a></span><span class="op">(</span><span class="st">"Set2"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">col</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/MsExperiment/man/MsExperiment.html" class="external-link">sampleData</a></span><span class="op">(</span><span class="va">mse</span><span class="op">)</span><span class="op">$</span><span class="va">sample_name</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' Define a color for each data file/sample</span></span>
<span><span class="va">col_sample</span> <span class="op">&lt;-</span> <span class="va">col</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/MsExperiment/man/MsExperiment.html" class="external-link">sampleData</a></span><span class="op">(</span><span class="va">mse</span><span class="op">)</span><span class="op">$</span><span class="va">sample_name</span><span class="op">]</span></span></code></pre></div>
</div>
</section><section class="section level2"><h2 id="data-visualization-and-general-quality-assessment">Data visualization and general quality assessment<a class="anchor" aria-label="anchor" href="#data-visualization-and-general-quality-assessment"></a>
</h2>
<p>For data inspection and a general data overview we first create base peak chromatograms (BPC) and total ion chromatograms (TIC) of the data set using the <code><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">chromatograms()</a></code> functions specifying either <code>"max"</code> (for BPC) or <code>"sum"</code> (for TIC) as the function to aggregate the per-spectrum intensities.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' BPC</span></span>
<span><span class="va">bpc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">chromatogram</a></span><span class="op">(</span><span class="va">mse</span>, aggregationFun <span class="op">=</span> <span class="st">"max"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bpc</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_sample</span>, <span class="fl">80</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">"BPC"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, col <span class="op">=</span> <span class="va">col</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">col</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">1</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div>
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-6-1.png" width="672"></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' TIC</span></span>
<span><span class="va">tic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">chromatogram</a></span><span class="op">(</span><span class="va">mse</span>, aggregationFun <span class="op">=</span> <span class="st">"max"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">tic</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_sample</span>, <span class="fl">80</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">"TIC"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, col <span class="op">=</span> <span class="va">col</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">col</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">1</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div>
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-7-1.png" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Based on the BPC and TIC there seems to be little retention time shifts between the samples. Also, no signal seems to be present before 20 seconds and after 850 seconds. Thus, we below filter the data set to spectra acquired within this retention time range.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' filter the data set to a retention time range from 20 to 850 seconds</span></span>
<span><span class="va">mse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/filterSpectra.html" class="external-link">filterSpectra</a></span><span class="op">(</span><span class="va">mse</span>, <span class="va">filterRt</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">850</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<p>BPC and TIC aggregate data along the <em>m/z</em> dimension per spectrum (retention time) to compare the signal measured along the retention time. To compare the <em>mass</em> or ion content of the individual samples/measurement runs we in addition aggregate data along the retention time, for distinct <em>m/z</em> values.</p>
<p>To this end we first bin each spectrum to get discrete and similar <em>m/z</em> values within the data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' bin mass peaks into into discrete m/z bins of 0.02 Da.</span></span>
<span><span class="va">s_bin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectra</a></span><span class="op">(</span><span class="va">mse</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">filterMsLevel</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">bin</a></span><span class="op">(</span>binSize <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' combine all spectra within the same sample into a single spectrum</span></span>
<span><span class="co">#' reporting the maximum intensity of all mass peaks with the same m/z bin</span></span>
<span><span class="va">bps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/combineSpectra.html" class="external-link">combineSpectra</a></span><span class="op">(</span><span class="va">s_bin</span>, f <span class="op">=</span> <span class="va">s_bin</span><span class="op">$</span><span class="va">dataOrigin</span>, intensityFun <span class="op">=</span> <span class="va">max</span><span class="op">)</span></span>
<span><span class="co">#' the same but reporting the sum of intensities per m/z bin</span></span>
<span><span class="va">tis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/combineSpectra.html" class="external-link">combineSpectra</a></span><span class="op">(</span><span class="va">s_bin</span>, f <span class="op">=</span> <span class="va">s_bin</span><span class="op">$</span><span class="va">dataOrigin</span>, intensityFun <span class="op">=</span> <span class="va">sum</span><span class="op">)</span></span></code></pre></div>
</div>
<p>We have thus a single aggregated mass spectrum per sample. These <em>base peak spectra</em> are plotted below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4.5</span>, <span class="fl">4</span>, <span class="fl">0</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html" class="external-link">plotSpectra</a></span><span class="op">(</span><span class="va">bps</span>, main <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-10-1.png" width="912"></p>
<figcaption>Aggregated MS1 spectrum per sample.</figcaption></figure>
</div>
</div>
</div>
<p>The <em>mass content</em> of the samples seems to be similar, with the exception of the last file. We can also plot all spectra into the same plot, using a different color per sample.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html" class="external-link">plotSpectraOverlay</a></span><span class="op">(</span><span class="va">bps</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_sample</span>, <span class="fl">40</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, col <span class="op">=</span> <span class="va">col</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">col</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div>
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-11-1.png" width="672"></p>
</figure>
</div>
</div>
</div>
<p>We can also use these aggregated spectra to calculate spectra similarity between the individual samples and cluster them.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">compareSpectra</a></span><span class="op">(</span><span class="va">bps</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MsExperiment/man/MsExperiment.html" class="external-link">sampleData</a></span><span class="op">(</span><span class="va">mse</span><span class="op">)</span><span class="op">$</span><span class="va">sample_desc</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/pheatmap/man/pheatmap.html" class="external-link">pheatmap</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-12-1.png" width="912"></p>
<figcaption>Similarity of <em>base peak spectra</em> of all samples in the experiment.</figcaption></figure>
</div>
</div>
</div>
<p>A15M, A5M and M samples cluster together, separately from the A45M samples while the PPL_R1 sample has a distinct mass peak profile.</p>
</section><section class="section level2"><h2 id="data-preprocessing">Data preprocessing<a class="anchor" aria-label="anchor" href="#data-preprocessing"></a>
</h2>
<p>Data preprocessing is the first step in the analysis of LC-MS data processing and analyzing the raw MS data to result in a two-dimensional quantification table of LC-MS <em>features</em> in the various samples of the experiment. This process consists of 3 main steps: <strong>chromatographic peak detection</strong>, <strong>retention time alignment</strong> and <strong>correspondence analysis</strong>. An additional <strong>gap-filling</strong> step can be conducted to reduce the number of missing values integrating raw MS signal from the expected <em>m/z</em> by retention time areas of defined LC-MS features.</p>
<p>Most methods in <em>xcms</em> are parallelized by default. Below we define the parallel processing setup for the present analysis.</p>
<div>
<blockquote>
<p><strong>Parallel processing details</strong></p>
<p>It is generally advisable to configure the parallel processing setup globally using <code><a href="https://rdrr.io/pkg/BiocParallel/man/register.html" class="external-link">register()</a></code>. On Unix machines <em>multi-core</em> parallel processing can be used, that shares memory between the parallel processes. Windows supports only <em>socket-based</em> parallel processing and starts a separate R for each parallel process. Below we globally define the parallel processing setup depending on the operating system. For the present analysis we use 4 parallel processes.</p>
</blockquote>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="va">.Platform</span><span class="op">$</span><span class="va">OS.type</span> <span class="op">==</span> <span class="st">"unix"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/BiocParallel/man/register.html" class="external-link">register</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocParallel/man/MulticoreParam-class.html" class="external-link">MulticoreParam</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/BiocParallel/man/register.html" class="external-link">register</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocParallel/man/SnowParam-class.html" class="external-link">SnowParam</a></span><span class="op">(</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<section class="level2"><h3 id="chromatographic-peak-detection">Chromatographic peak detection<a class="anchor" aria-label="anchor" href="#chromatographic-peak-detection"></a>
</h3>
<p>The aim of the chromatographic peak detection is to identify and quantify signal in the raw MS data space representing signal from ions of compounds present in a sample. Data processing is performed separately for each data file and mass peak intensities with similar <em>m/z</em> are evaluated along retention time axis to identify chromatographic peaks. We use the <em>centWave</em> algorithm for peak detection. The most important parameter for <em>centWave</em> is <code>peakwidth</code> which defines an approximate lower and upper expected width of chromatographic peaks in retention time dimension. Without any prior information, we need to derive this information from the data set. We therefore zoom into areas of the BPC that seem to contain signal from an ion.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' extract BPC</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">bpc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">chromatogram</a></span><span class="op">(</span><span class="va">mse</span>, aggregationFun <span class="op">=</span> <span class="st">"max"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bpc</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_sample</span>, <span class="fl">80</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' identify a retention time region to extract</span></span>
<span><span class="va">rtr_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">105</span>, <span class="fl">130</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="va">rtr_1</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' identify the m/z with the largest intensity in that region:</span></span>
<span><span class="co">#' - restrict to MS1 data</span></span>
<span><span class="co">#' - filter the MS data by retention time</span></span>
<span><span class="co">#' - extract the MS data as a data.frame</span></span>
<span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectra</a></span><span class="op">(</span><span class="va">mse</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">filterMsLevel</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">filterRt</a></span><span class="op">(</span><span class="va">rtr_1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">longForm</span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mz"</span>, <span class="st">"intensity"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' define a m/z range around the m/z with largest intensity</span></span>
<span><span class="va">mzr_1</span> <span class="op">&lt;-</span> <span class="va">tmp</span><span class="op">$</span><span class="va">mz</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">$</span><span class="va">intensity</span><span class="op">)</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.005</span>, <span class="fl">0.005</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' extract an EIC for that RT and m/z region</span></span>
<span><span class="va">eic_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">chromatogram</a></span><span class="op">(</span><span class="va">mse</span>, rt <span class="op">=</span> <span class="va">rtr_1</span>, mz <span class="op">=</span> <span class="va">mzr_1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">eic_1</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_sample</span>, <span class="fl">80</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-14-1.png" width="912"></p>
<figcaption>Definition of an example region for EIC extraction. Upper panel: BPC, dashed vertical lines indicate the selected retention time region. Lower panel: EIC for the <em>m/z</em> region with the largest signal in the retention time window.</figcaption></figure>
</div>
</div>
</div>
<p>The width of this chromatographic peaks is about 8 seconds. We evaluate a second signal at the and of the chromatogram.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bpc</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_sample</span>, <span class="fl">80</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' identify a region to extract</span></span>
<span><span class="va">rtr_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">720</span>, <span class="fl">770</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span>v <span class="op">=</span> <span class="va">rtr_2</span>, lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' identify the m/z with the largest intensity in that region:</span></span>
<span><span class="co">#' - restrict to MS1 data</span></span>
<span><span class="co">#' - filter the MS data by retention time</span></span>
<span><span class="co">#' - extract the MS data as a data.frame</span></span>
<span><span class="va">tmp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">spectra</a></span><span class="op">(</span><span class="va">mse</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">filterMsLevel</a></span><span class="op">(</span><span class="fl">1L</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">filterRt</a></span><span class="op">(</span><span class="va">rtr_2</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">longForm</span><span class="op">(</span>columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mz"</span>, <span class="st">"intensity"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' define a m/z range around the m/z with largest intensity</span></span>
<span><span class="va">mzr_2</span> <span class="op">&lt;-</span> <span class="va">tmp</span><span class="op">$</span><span class="va">mz</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">tmp</span><span class="op">$</span><span class="va">intensity</span><span class="op">)</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.005</span>, <span class="fl">0.005</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' extract an EIC for that RT and m/z region</span></span>
<span><span class="va">eic_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">chromatogram</a></span><span class="op">(</span><span class="va">mse</span>, rt <span class="op">=</span> <span class="va">rtr_2</span>, mz <span class="op">=</span> <span class="va">mzr_2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">eic_2</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_sample</span>, <span class="fl">80</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-15-1.png" width="912"></p>
<figcaption>Definition of an example region for EIC extraction. Upper panel: BPC, dashed vertical lines indicate the selected retention time region. Lower panel: EIC for the <em>m/z</em> region with the largest signal in the retention time window.</figcaption></figure>
</div>
</div>
</div>
<p>The width of the chromatographic peaks for that <em>m/z</em> slice seem to be around 15 seconds. Also, there seems to be a considerable shift in retention times between the samples.</p>
<p>Based on these two example signals we define the <code>peakdwidth</code> parameter for the present data set to be between and 5 and 20 seconds. For a <em>real</em> data analysis it is suggested to evaluate more signals, also eventually of internal standards or ions of compounds that are expected to be present in the sample.</p>
<p>A second potentially data set-specific parameter of the <em>centWave</em> algorithm is <code>ppm</code>. It defines the maximum allowed deviation in <em>m/z</em> dimension of mass peaks in consecutive spectra considered to represent signal from the same ion. To illustrate this we below subset the full MS data from the first data file to the <em>m/z</em> and retention time range defined above and plot the individual mass peaks.</p>
<div>
<blockquote>
<p><strong>Details on the <code>ppm</code> <em>centWave</em> parameter</strong></p>
<p>The <code>ppm</code> parameter defines the expected (or observed) <em>m/z</em> deviation of mass peaks representing signal from the same compound/ion in consecutive spectra. This scattering of mass peak’s <em>m/z</em> values can depend on the centroiding algorithm used or the precision of the MS instrument. In addition, on TOF instruments, the scattering can depend on the intensity of the signal, with higher variation observed for low intensity peaks and increasing stability with higher signal.</p>
</blockquote>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mse</span><span class="op">[</span><span class="fl">1L</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/filterSpectra.html" class="external-link">filterSpectra</a></span><span class="op">(</span><span class="va">filterMsLevel</span>, <span class="fl">1L</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/filterSpectra.html" class="external-link">filterSpectra</a></span><span class="op">(</span><span class="va">filterRt</span>, rt <span class="op">=</span> <span class="va">rtr_1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/filterSpectra.html" class="external-link">filterSpectra</a></span><span class="op">(</span><span class="va">filterMzRange</span>, mz <span class="op">=</span> <span class="va">mzr_1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div>
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-16-1.png" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The individual mass peaks are shown in the lower panel in the plot above. For the present ion, the <em>m/z</em> values show a very low variance.</p>
<p>We evaluate the signal also for the second <em>m/z</em> - retention time window defined above.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mse</span><span class="op">[</span><span class="fl">1L</span><span class="op">]</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/filterSpectra.html" class="external-link">filterSpectra</a></span><span class="op">(</span><span class="va">filterMsLevel</span>, <span class="fl">1L</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/filterSpectra.html" class="external-link">filterSpectra</a></span><span class="op">(</span><span class="va">filterRt</span>, rt <span class="op">=</span> <span class="va">rtr_2</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/filterSpectra.html" class="external-link">filterSpectra</a></span><span class="op">(</span><span class="va">filterMzRange</span>, mz <span class="op">=</span> <span class="va">mzr_2</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div>
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-17-1.png" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The scattering of <em>m/z</em> values looks larger, but is still below 0.001 Da. We nevertheless use a <code>ppm = 20</code> for the present data set - as we do not assume that ions from different compounds elute at the same time with a difference in ppm lower than 20.</p>
<p>Below we define the settings for <em>centWave</em> and perform the chromatographic peak detection on the full data set. Note that it can also be helpful to test the different settings by performing peak detection on extracted ion chromatograms as described in <a href="https://rformassspectrometry.github.io/Metabonaut/" class="external-link">Metabonaut</a>. Parameter <code>chunkSize</code> defines the number of data files from which MS data should be loaded at a time. This parameter thus has an influence on the memory usage of the analysis.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' configure and perform chromatographic peak detection</span></span>
<span><span class="va">cwp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/findChromPeaks-centWave.html" class="external-link">CentWaveParam</a></span><span class="op">(</span></span>
<span>    ppm <span class="op">=</span> <span class="fl">20</span>,</span>
<span>    peakwidth <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">20</span><span class="op">)</span>,</span>
<span>    snthresh <span class="op">=</span> <span class="fl">8</span>,</span>
<span>    integrate <span class="op">=</span> <span class="fl">2</span>,</span>
<span>    mzdiff <span class="op">=</span> <span class="fl">0.001</span></span>
<span><span class="op">)</span></span>
<span><span class="va">mse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/findChromPeaks.html" class="external-link">findChromPeaks</a></span><span class="op">(</span><span class="va">mse</span>, param <span class="op">=</span> <span class="va">cwp</span>, chunkSize <span class="op">=</span> <span class="fl">4L</span><span class="op">)</span></span></code></pre></div>
</div>
<p>In most cases it is also advisable to perform a <em>peak postprocessing</em> to remove artifacts of the <em>centWave</em> peak detection (e.g. overlapping or split peaks). Below we perform such peak refinement which will merge partially or completely overlapping chromatographic peak, or those that are less than 2 seconds apart from each other, if the intensity below both apexes is lower than a certain proportion of the apex intensity of the lower intensity peak.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' configure and perform *peak refinement*</span></span>
<span><span class="va">mnpp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/refineChromPeaks.html" class="external-link">MergeNeighboringPeaksParam</a></span><span class="op">(</span></span>
<span>    expandRt <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    expandMz <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    ppm <span class="op">=</span> <span class="fl">0</span>,</span>
<span>    minProp <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span></span>
<span><span class="va">mse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/refineChromPeaks.html" class="external-link">refineChromPeaks</a></span><span class="op">(</span><span class="va">mse</span>, <span class="va">mnpp</span>, chunkSize <span class="op">=</span> <span class="fl">4L</span><span class="op">)</span></span></code></pre></div>
</div>
<p>We next compare the number of identified peaks per sample as well as their <em>m/z</em> and retention time widths.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' split the detected chrom peaks per sample</span></span>
<span><span class="va">pk_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split.data.frame</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-class.html" class="external-link">chromPeaks</a></span><span class="op">(</span><span class="va">mse</span>, columns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mzmin"</span>, <span class="st">"mzmax"</span>, <span class="st">"rtmin"</span>, <span class="st">"rtmax"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-class.html" class="external-link">chromPeaks</a></span><span class="op">(</span><span class="va">mse</span>, columns <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span><span class="op">[</span>, <span class="st">"sample"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#' calculate mz and rt widths</span></span>
<span><span class="va">pk_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">pk_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">z</span>, mz_width <span class="op">=</span> <span class="va">z</span><span class="op">[</span>, <span class="st">"mzmax"</span><span class="op">]</span> <span class="op">-</span> <span class="va">z</span><span class="op">[</span>, <span class="st">"mzmin"</span><span class="op">]</span>,</span>
<span>          mz_width_ppm <span class="op">=</span> <span class="op">(</span><span class="va">z</span><span class="op">[</span>, <span class="st">"mzmax"</span><span class="op">]</span> <span class="op">-</span> <span class="va">z</span><span class="op">[</span>, <span class="st">"mzmin"</span><span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="fl">1e6</span> <span class="op">/</span> <span class="va">z</span><span class="op">[</span>, <span class="st">"mzmax"</span><span class="op">]</span>,</span>
<span>          rt_width <span class="op">=</span> <span class="va">z</span><span class="op">[</span>, <span class="st">"rtmax"</span><span class="op">]</span> <span class="op">-</span> <span class="va">z</span><span class="op">[</span>, <span class="st">"rtmin"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' plot the information</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4.3</span>, <span class="fl">1.5</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html" class="external-link">barplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">pk_list</span>, <span class="va">nrow</span><span class="op">)</span><span class="op">)</span>,</span>
<span>     col <span class="op">=</span> <span class="va">col_sample</span>,</span>
<span>     ylab <span class="op">=</span> <span class="st">"peak count"</span>, main <span class="op">=</span> <span class="st">"Peak detection summary, mse"</span>, xaxt <span class="op">=</span> <span class="st">"n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"top"</span>, horiz <span class="op">=</span> <span class="cn">TRUE</span>, col <span class="op">=</span> <span class="va">col</span>, pch <span class="op">=</span> <span class="fl">15</span>,</span>
<span>       legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">col</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4.3</span>, <span class="fl">0</span>, <span class="fl">0.1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/vioplot/man/vioplot.html" class="external-link">vioplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">pk_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="va">z</span><span class="op">[</span>, <span class="st">"mz_width_ppm"</span><span class="op">]</span><span class="op">)</span>, outline <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        ylab <span class="op">=</span> <span class="st">"m/z width [ppm]"</span>, xaxt <span class="op">=</span> <span class="st">"n"</span>,</span>
<span>        col <span class="op">=</span> <span class="va">col_sample</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/vioplot/man/vioplot.html" class="external-link">vioplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">pk_list</span>, <span class="kw">function</span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="va">z</span><span class="op">[</span>, <span class="st">"rt_width"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>        ylab <span class="op">=</span> <span class="st">"rt width [s]"</span>, col <span class="op">=</span> <span class="va">col_sample</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div>
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-20-1.png" width="672"></p>
</figure>
</div>
</div>
</div>
<p>The highest number of peaks was detected in the <em>PPL</em> sample. Apart from that sample, the numbers of detected peaks is comparable in the data set. Also the <em>m/z</em> width and the retention time widths. As expected, most of the identified chromatographic peaks are about 10 seconds wide. Also, their <em>m/z</em> width is below 10 ppm for most peaks, but some show also a larger <em>m/z</em> widths.</p>
<p>We also evaluate the peak detection results on the two example <em>m/z</em> - retention time regions. Identified chromatographic peaks will be colored according to the sample group.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eic_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">chromatogram</a></span><span class="op">(</span><span class="va">mse</span>, mz <span class="op">=</span> <span class="va">mzr_1</span>, rt <span class="op">=</span> <span class="va">rtr_1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' define a color for each chromatographic peak</span></span>
<span><span class="va">col_peak</span> <span class="op">&lt;-</span> <span class="va">col_sample</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-class.html" class="external-link">chromPeaks</a></span><span class="op">(</span><span class="va">eic_1</span><span class="op">)</span><span class="op">[</span>, <span class="st">"sample"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">eic_1</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_sample</span>, <span class="fl">80</span><span class="op">)</span>,</span>
<span>     peakBg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_peak</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>     peakCol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_peak</span>, <span class="fl">80</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, col <span class="op">=</span> <span class="va">col</span>, lty <span class="op">=</span> <span class="fl">1</span>,</span>
<span>       legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">col</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-21-1.png" width="672"></p>
<figcaption>Chromatographic peak detection results on the first example EIC.</figcaption></figure>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eic_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">chromatogram</a></span><span class="op">(</span><span class="va">mse</span>, mz <span class="op">=</span> <span class="va">mzr_2</span>, rt <span class="op">=</span> <span class="va">rtr_2</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' define a color for each chromatographic peak</span></span>
<span><span class="va">col_peak</span> <span class="op">&lt;-</span> <span class="va">col_sample</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-class.html" class="external-link">chromPeaks</a></span><span class="op">(</span><span class="va">eic_2</span><span class="op">)</span><span class="op">[</span>, <span class="st">"sample"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">eic_2</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_sample</span>, <span class="fl">80</span><span class="op">)</span>,</span>
<span>     peakBg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_peak</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>     peakCol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_peak</span>, <span class="fl">80</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, col <span class="op">=</span> <span class="va">col</span>, lty <span class="op">=</span> <span class="fl">1</span>,</span>
<span>       legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">col</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-22-1.png" width="672"></p>
<figcaption>Chromatographic peak detection results on the second example EIC.</figcaption></figure>
</div>
</div>
</div>
</section><section class="level2"><h3 id="retention-time-alignment">Retention time alignment<a class="anchor" aria-label="anchor" href="#retention-time-alignment"></a>
</h3>
<p>The aim of the retention time alignment step is to reduce differences observed in the elution time of compounds between different LC-MS runs. A variety of methods for this have been proposed and some are also implemented in <em>xcms</em>. We use the most straight forward approach that aligns chromatographic runs based on retention times of <em>anchor peaks</em>, i.e., compounds present in most of the samples of an experiment. To define these anchor peaks we must however perform an initial correspondence analysis and group chromatographic peaks with similar <em>m/z</em> and retention time across samples.</p>
<p>We use the <em>peak density</em> correspondence method which groups chromatographic peaks into an LC-MS feature, if their <em>m/z</em> difference is smaller than <code>binSize</code> (+ <code>ppm</code> of the <em>m/z</em>), the retention time of their apex is within one peak of the <em>peak density</em> curve (which smoothness can be configured with parameter <code>bw</code>) and a chromatographic peak is present in at least <code>minFraction</code> of at least one of the sample groups defined with <code>sampleGroups</code>. For the initial correspondence we apply more relaxed settings and consider all samples to be in the same sample group (since we want to define anchor peaks that are present in most samples).</p>
<div>
<blockquote>
<p><strong>Details on <code>PeakDensityParam</code> settings</strong></p>
<p>The <em>peak density</em> correspondence method can be configured using the <code>PeakDensityParam</code>. For an initial correspondence used for retention time alignment more relaxed settings can be used, also putting all samples into the same <em>sample group</em>. The important parameters are <code>bw</code> and <code>binSize</code>. The former defines the tolerance of retention time similarity, the latter the similarity of <em>m/z</em> values for chromatographic peaks from different samples to be considered to represent signal from ions of the same compound. Setting <code>binSize</code> is straight forward - it depends on the resolution of the instrument and the expected similarity of <em>m/z</em> values for the same ion. We set it to a value of <code>binSize = 0.01</code>, hence all chromatographic peaks with a difference in <em>m/z</em> smaller than 0.01 would be evaluated. The <code>bw</code> parameter is a bit more difficult to define. It should be defined based on observed data in the experiment, ideally, on EICs of closely eluting compounds with the same <em>m/z</em>. In our example we use the second example <em>m/z</em> - retention time range, because it seemed to contain signal from the same compound, but with quite large shifts between data files. We below <em>simulate</em> a correspondence analysis on this EIC. Other parameters defined are <code>minFraction</code>, which defines the minimum required proportion of samples of one of the sample groups defined with parameter <code>sampleGroups</code> in which a chromatographic peak is present, and <code>ppm</code> which, together with <code>binSize</code> defines the maximal accepted difference in chromatographic peaks’ <em>m/z</em> values to consider them for grouping.</p>
</blockquote>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pdp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/groupChromPeaks.html" class="external-link">PeakDensityParam</a></span><span class="op">(</span></span>
<span>    sampleGroups <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">mse</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    bw <span class="op">=</span> <span class="fl">2</span>,</span>
<span>    minFraction <span class="op">=</span> <span class="fl">0.2</span>,</span>
<span>    binSize <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>    ppm <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">col_peak</span> <span class="op">&lt;-</span> <span class="va">col_sample</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-class.html" class="external-link">chromPeaks</a></span><span class="op">(</span><span class="va">eic_2</span><span class="op">)</span><span class="op">[</span>, <span class="st">"sample"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/plotChromPeakDensity.html" class="external-link">plotChromPeakDensity</a></span><span class="op">(</span><span class="va">eic_2</span>, param <span class="op">=</span> <span class="va">pdp</span>, col <span class="op">=</span> <span class="va">col_sample</span>, peakCol <span class="op">=</span> <span class="va">col_peak</span>,</span>
<span>                     peakBg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_peak</span>, <span class="fl">40</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-23-1.png" width="672"></p>
<figcaption>Correspondence analysis simulation on the second example EIC.</figcaption></figure>
</div>
</div>
</div>
<p>The upper panel of this plot shows the EIC, the lower panel the data considered for correspondence: it shows the retention time of the apex positions of all chromatographic peaks in that <em>m/z</em> slice on the x-axis against the sample in which the chromatographic peak was detected on the y-axis. The black solid line represents the <em>peak density estimate</em>, calculated based on the retention times of the chromatographic peaks and parameter <code>bw</code> with larger values of <code>bw</code> resulting in more smooth curves.</p>
<p>With the used settings, in particular parameter <code>bw</code>, the present chromatographic peaks would be split into two separate LC-MS features (indicated with a grey rectangle in the lower panel). Assuming that all peaks in that region represent signal from ions of the same compound, we however want to group them into the same feature. We hence next increase the <code>bw</code> parameter and simulate the correspondence with these updated settings.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pdp</span><span class="op">@</span><span class="va">bw</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/plotChromPeakDensity.html" class="external-link">plotChromPeakDensity</a></span><span class="op">(</span><span class="va">eic_2</span>, param <span class="op">=</span> <span class="va">pdp</span>, col <span class="op">=</span> <span class="va">col_sample</span>, peakCol <span class="op">=</span> <span class="va">col_peak</span>,</span>
<span>                     peakBg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_peak</span>, <span class="fl">40</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-24-1.png" width="672"></p>
<figcaption>Correspondence analysis simulation with <code>bw = 5</code>.</figcaption></figure>
</div>
</div>
</div>
<p>Changing <code>bw</code> to 5 changed the density curve, but we still defined two separate features. We thus increase below <code>bw</code> to 7.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pdp</span><span class="op">@</span><span class="va">bw</span> <span class="op">&lt;-</span> <span class="fl">7</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/plotChromPeakDensity.html" class="external-link">plotChromPeakDensity</a></span><span class="op">(</span><span class="va">eic_2</span>, param <span class="op">=</span> <span class="va">pdp</span>, col <span class="op">=</span> <span class="va">col_sample</span>, peakCol <span class="op">=</span> <span class="va">col_peak</span>,</span>
<span>                     peakBg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_peak</span>, <span class="fl">40</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-25-1.png" width="672"></p>
<figcaption>Correspondence analysis simulation with <code>bw = 7</code>.</figcaption></figure>
</div>
</div>
</div>
<p>With a <code>bw = 7</code> a single feature was defined. We use these parameter for the initial correspondence analysis on the full data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' perform initial correspondence analysis to group chromatographic peaks</span></span>
<span><span class="va">mse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/groupChromPeaks.html" class="external-link">groupChromPeaks</a></span><span class="op">(</span><span class="va">mse</span>, param <span class="op">=</span> <span class="va">pdp</span><span class="op">)</span></span></code></pre></div>
</div>
<p>For the retention time alignment we use the before mentioned <em>peak groups</em> method that aligns LC runs by minimizing retention time differences of so called anchor peaks. This alignment method is very robust and also flexible, allowing for example to align samples based on within-experiment QC samples, or against external reference data or based on manually defined anchor peaks. See <a href="https://rformassspectrometry.github.io/Metabonaut" class="external-link">Metabonaut</a> for examples and options. The method can be configured with <code><a href="https://rdrr.io/pkg/xcms/man/adjustRtime.html" class="external-link">PeakGroupsParam()</a></code>. With <code>minFraction = 0.9</code> we below define anchor peaks as those LC-MS features (defined by the initial correspondence analysis) for which a chromatographic peak was identified in 90% of the samples of the whole experiment. The observed retention time differences of these are used to model a curve along retention time dimension which is then used to align the retention times of all samples. The smoothness of this curve can be configured with parameter <code>span</code> (values between 0 and 1; values around 0.5 work in most cases).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' configure and run retention time alignment</span></span>
<span><span class="va">pgp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/adjustRtime.html" class="external-link">PeakGroupsParam</a></span><span class="op">(</span></span>
<span>    minFraction <span class="op">=</span> <span class="fl">0.90</span>,</span>
<span>    span <span class="op">=</span> <span class="fl">0.4</span><span class="op">)</span></span>
<span><span class="va">mse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/adjustRtime.html" class="external-link">adjustRtime</a></span><span class="op">(</span><span class="va">mse</span>, param <span class="op">=</span> <span class="va">pgp</span><span class="op">)</span></span></code></pre></div>
</div>
<p>The effect of this alignment can be visualized with the <code><a href="https://rdrr.io/pkg/xcms/man/plotAdjustedRtime.html" class="external-link">plotAdjustedRtime()</a></code> function. It plots the adjusted retention times of each sample on the x-axis against the difference between the adjusted and raw retention times on the y-axis as a solid line. Retention times of anchor peaks in each sample are indicated with individual data points. These should ideally be placed along the full retention time range of the experiment.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' visualize alignment results</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/plotAdjustedRtime.html" class="external-link">plotAdjustedRtime</a></span><span class="op">(</span><span class="va">mse</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_sample</span>, <span class="fl">80</span><span class="op">)</span>,</span>
<span>                  peakGroupsPch <span class="op">=</span> <span class="fl">21</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topleft"</span>, col <span class="op">=</span> <span class="va">col</span>, lty <span class="op">=</span> <span class="fl">1</span>,</span>
<span>       legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">col</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-28-1.png" width="672"></p>
<figcaption>Retention time alignment results.</figcaption></figure>
</div>
</div>
</div>
<p>Anchor points span the full retention time range. Retention time adjustments for most samples were below 2-4 seconds, with the exception of 3 samples for which a considerably larger adjustment is present after 500 seconds, and the PPL sample with larger retention time differences after 650 seconds.</p>
<p>We next evaluate the alignment results based on the BPC before and after alignment.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' create a BPC after adjustment; chromPeaks = "none" only creates the BPC</span></span>
<span><span class="co">#' without extracting also identified chromatographic peaks.</span></span>
<span><span class="va">bpc_adj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">chromatogram</a></span><span class="op">(</span><span class="va">mse</span>, chromPeaks <span class="op">=</span> <span class="st">"none"</span>, aggregationFun <span class="op">=</span> <span class="st">"max"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bpc</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_sample</span>, <span class="fl">80</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">"BPC, raw"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, col <span class="op">=</span> <span class="va">col</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">col</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">1</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">bpc_adj</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_sample</span>, <span class="fl">80</span><span class="op">)</span>, main <span class="op">=</span> <span class="st">"BPC, adjusted"</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-29-1.png" width="912"></p>
<figcaption>BPC before (top) and after (bottom) retention time alignment.</figcaption></figure>
</div>
</div>
</div>
<p>Misalignment of signal at the later stage of the chromatography seems to be reduced. We in addition evaluate the effect of retention time alignment on the two example EICs.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eic_1_adj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">chromatogram</a></span><span class="op">(</span><span class="va">mse</span>, rt <span class="op">=</span> <span class="va">rtr_1</span>, mz <span class="op">=</span> <span class="va">mzr_1</span>, chromPeaks <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">eic_1</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_sample</span>, <span class="fl">80</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">2</span>, peakType <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, col <span class="op">=</span> <span class="va">col</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">col</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">1</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">eic_1_adj</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_sample</span>, <span class="fl">80</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-30-1.png" width="912"></p>
<figcaption>First example EIC before (top) and after (bottom) retention time alignment.</figcaption></figure>
</div>
</div>
</div>
<p>For this early retention time range already the raw signal was well aligned.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eic_2_adj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">chromatogram</a></span><span class="op">(</span><span class="va">mse</span>, rt <span class="op">=</span> <span class="va">rtr_2</span>, mz <span class="op">=</span> <span class="va">mzr_2</span>, chromPeaks <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">eic_2</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_sample</span>, <span class="fl">80</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">2</span>, peakType <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, col <span class="op">=</span> <span class="va">col</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">col</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">1</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">eic_2_adj</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_sample</span>, <span class="fl">80</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-31-1.png" width="912"></p>
<figcaption>Second example EIC before (top) and after (bottom) retention time alignment.</figcaption></figure>
</div>
</div>
</div>
<p>This later retention time range shows clear, and strong, differences in retention times of 4 samples. While the <em>PPL</em> sample could be aligned quite well using the above settings, 3 samples still show considerable shifts in retention times. We thus re-perform the alignment reducing the value for the <code>span</code> parameter to switch to a more <em>local</em> alignment of the samples. We below first <em>undo</em> the retention time alignment, re-perform the initial correspondence analysis and perform the alignment with the changed settings for parameter <code>span</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' remove retention time alignment results</span></span>
<span><span class="va">mse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-class.html" class="external-link">dropAdjustedRtime</a></span><span class="op">(</span><span class="va">mse</span><span class="op">)</span></span>
<span><span class="co">#' re-perform initial correspondence</span></span>
<span><span class="va">mse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/groupChromPeaks.html" class="external-link">groupChromPeaks</a></span><span class="op">(</span><span class="va">mse</span>, param <span class="op">=</span> <span class="va">pdp</span><span class="op">)</span></span>
<span><span class="co">#' perform the alignment using updated settings</span></span>
<span><span class="va">pgp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/adjustRtime.html" class="external-link">PeakGroupsParam</a></span><span class="op">(</span></span>
<span>    minFraction <span class="op">=</span> <span class="fl">0.90</span>,</span>
<span>    span <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span>
<span><span class="va">mse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/adjustRtime.html" class="external-link">adjustRtime</a></span><span class="op">(</span><span class="va">mse</span>, param <span class="op">=</span> <span class="va">pgp</span><span class="op">)</span></span></code></pre></div>
</div>
<p>Evaluating the impact of changing this parameter.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' visualize alignment results</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/plotAdjustedRtime.html" class="external-link">plotAdjustedRtime</a></span><span class="op">(</span><span class="va">mse</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_sample</span>, <span class="fl">80</span><span class="op">)</span>,</span>
<span>                  peakGroupsPch <span class="op">=</span> <span class="fl">21</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topleft"</span>, col <span class="op">=</span> <span class="va">col</span>, lty <span class="op">=</span> <span class="fl">1</span>,</span>
<span>       legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">col</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-33-1.png" width="672"></p>
<figcaption>Retention time alignment results.</figcaption></figure>
</div>
</div>
</div>
<p>A stronger alignment can be observed for the retention time area from 750 to 800 seconds. The results for the first example EIC did not change.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eic_1_adj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">chromatogram</a></span><span class="op">(</span><span class="va">mse</span>, rt <span class="op">=</span> <span class="va">rtr_1</span>, mz <span class="op">=</span> <span class="va">mzr_1</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#' Setting peakType = "none" prevents identified chromatographic peaks to be</span></span>
<span><span class="co">#' indicated in the plot.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">eic_1</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_sample</span>, <span class="fl">80</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">2</span>, peakType <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, col <span class="op">=</span> <span class="va">col</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">col</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">1</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">eic_1_adj</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_sample</span>, <span class="fl">80</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">2</span>, peakType <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-34-1.png" width="912"></p>
<figcaption>First example EIC before (top) and after (bottom) retention time alignment.</figcaption></figure>
</div>
</div>
</div>
<p>While for the second EIC the alignment improved.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eic_2_adj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">chromatogram</a></span><span class="op">(</span><span class="va">mse</span>, rt <span class="op">=</span> <span class="va">rtr_2</span>, mz <span class="op">=</span> <span class="va">mzr_2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">eic_2</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_sample</span>, <span class="fl">80</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">2</span>, peakType <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, col <span class="op">=</span> <span class="va">col</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">col</span><span class="op">)</span>, lty <span class="op">=</span> <span class="fl">1</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">eic_2_adj</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_sample</span>, <span class="fl">80</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">2</span>, peakType <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-35-1.png" width="912"></p>
<figcaption>Second example EIC before (top) and after (bottom) retention time alignment.</figcaption></figure>
</div>
</div>
</div>
<p>Note that in most cases it is not necessary that all samples are perfectly aligned. Some variation in retention time can be accounted for in the final correspondence analysis.</p>
</section><section class="level2"><h3 id="correspondence-analysis">Correspondence analysis<a class="anchor" aria-label="anchor" href="#correspondence-analysis"></a>
</h3>
<p>The correspondence analysis groups chromatographic peaks from different samples, all assumed to represent signal from ions of the same compound, into LC-MS features. Signals are generally grouped together based on similarity of their <em>m/z</em> and retention times. We use the <em>peak density</em> method and, similarly to what we did in the previous section, we first evaluate the impact of different parameter settings on the expected results. Also, for the final correspondence we use the samples’ <em>sample_name</em> for parameter <code>sampleGroup</code>. Combined with setting <code>minFraction = 0.67</code>, an LC-MS feature is defined if a chromatographic peak is present in at least 67% of the replicates per sample (i.e., 2 out of 3).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' configure the *peak density* correspondence method</span></span>
<span><span class="va">pdp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/groupChromPeaks.html" class="external-link">PeakDensityParam</a></span><span class="op">(</span></span>
<span>    sampleGroups <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/MsExperiment/man/MsExperiment.html" class="external-link">sampleData</a></span><span class="op">(</span><span class="va">mse</span><span class="op">)</span><span class="op">$</span><span class="va">sample_name</span>,</span>
<span>    minFraction <span class="op">=</span> <span class="fl">0.67</span>,</span>
<span>    binSize <span class="op">=</span> <span class="fl">0.01</span>,</span>
<span>    ppm <span class="op">=</span> <span class="fl">10</span>,</span>
<span>    bw <span class="op">=</span> <span class="fl">7</span><span class="op">)</span></span></code></pre></div>
</div>
<p>We evaluate these settings, in particular the effect of <code>bw</code> on the first example EIC.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">col_peak</span> <span class="op">&lt;-</span> <span class="va">col_sample</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-class.html" class="external-link">chromPeaks</a></span><span class="op">(</span><span class="va">eic_1_adj</span><span class="op">)</span><span class="op">[</span>, <span class="st">"sample"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/plotChromPeakDensity.html" class="external-link">plotChromPeakDensity</a></span><span class="op">(</span><span class="va">eic_1_adj</span>, param <span class="op">=</span> <span class="va">pdp</span>, col <span class="op">=</span> <span class="va">col_sample</span>,</span>
<span>                     peakCol <span class="op">=</span> <span class="va">col_peak</span>, peakBg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_peak</span>, <span class="fl">40</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-37-1.png" width="672"></p>
<figcaption>Simulation of correspondence analysis on the first example EIC.</figcaption></figure>
</div>
</div>
</div>
<p>For that EIC the settings worked nicely. Simulating the correspondence for the second example EIC.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">col_peak</span> <span class="op">&lt;-</span> <span class="va">col_sample</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-class.html" class="external-link">chromPeaks</a></span><span class="op">(</span><span class="va">eic_2_adj</span><span class="op">)</span><span class="op">[</span>, <span class="st">"sample"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/plotChromPeakDensity.html" class="external-link">plotChromPeakDensity</a></span><span class="op">(</span><span class="va">eic_2_adj</span>, param <span class="op">=</span> <span class="va">pdp</span>, col <span class="op">=</span> <span class="va">col_sample</span>,</span>
<span>                     peakCol <span class="op">=</span> <span class="va">col_peak</span>, peakBg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_peak</span>, <span class="fl">40</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-38-1.png" width="672"></p>
<figcaption>Simulation of correspondence analysis on the second example EIC.</figcaption></figure>
</div>
</div>
</div>
<p>Also for the second EIC all chromatographic peaks got grouped into the same feature. Ideally, correspondence parameters should also be simulated on more complex signals, e.g. regions with co- or closely eluting compounds. We below expand the retention time window for the <em>m/z</em> slice of the first example EIC.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">chromatogram</a></span><span class="op">(</span><span class="va">mse</span>, mz <span class="op">=</span> <span class="va">mzr_1</span>, rt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">150</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">col_peak</span> <span class="op">&lt;-</span> <span class="va">col_sample</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-class.html" class="external-link">chromPeaks</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span><span class="op">[</span>, <span class="st">"sample"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/plotChromPeakDensity.html" class="external-link">plotChromPeakDensity</a></span><span class="op">(</span><span class="va">a</span>, param <span class="op">=</span> <span class="va">pdp</span>, col <span class="op">=</span> <span class="va">col_sample</span>,</span>
<span>                     peakCol <span class="op">=</span> <span class="va">col_peak</span>, peakBg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_peak</span>, <span class="fl">40</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-39-1.png" width="672"></p>
<figcaption>Simulation of correspondence analysis on an expanded RT window.</figcaption></figure>
</div>
</div>
</div>
<p>There seem to be signal from 3 different compounds in that <em>m/z</em> slice. Using the settings above, in particular with <code>bw = 7</code> the apparently different chromatographic signals at about 105 and 115 seconds are grouped into the same LC-MS feature as indicated with the grey rectangle in the plot above. Unless we want that these signals are grouped together, we need to reduce the value of <code>bw</code>. Below we simulate a correspondence using <code>bw = 3</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pdp</span><span class="op">@</span><span class="va">bw</span> <span class="op">&lt;-</span> <span class="fl">3</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/plotChromPeakDensity.html" class="external-link">plotChromPeakDensity</a></span><span class="op">(</span><span class="va">a</span>, param <span class="op">=</span> <span class="va">pdp</span>, col <span class="op">=</span> <span class="va">col_sample</span>,</span>
<span>                     peakCol <span class="op">=</span> <span class="va">col_peak</span>, peakBg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_peak</span>, <span class="fl">40</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-40-1.png" width="672"></p>
<figcaption>Effect of changing to <code>bw = 3</code> for the correspondence analysis.</figcaption></figure>
</div>
</div>
</div>
<p>With <code>bw = 3</code> we successfully grouped the signals into 3 distinct features. We next evaluate whether with these updated setting we would still group the signal from the second example EIC into a single feature.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">col_peak</span> <span class="op">&lt;-</span> <span class="va">col_sample</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-class.html" class="external-link">chromPeaks</a></span><span class="op">(</span><span class="va">eic_2_adj</span><span class="op">)</span><span class="op">[</span>, <span class="st">"sample"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/plotChromPeakDensity.html" class="external-link">plotChromPeakDensity</a></span><span class="op">(</span><span class="va">eic_2_adj</span>, param <span class="op">=</span> <span class="va">pdp</span>, col <span class="op">=</span> <span class="va">col_sample</span>,</span>
<span>                     peakCol <span class="op">=</span> <span class="va">col_peak</span>, peakBg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_peak</span>, <span class="fl">40</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-41-1.png" width="672"></p>
<figcaption>Effect of <code>bw = 3</code> on correspondence results of the second example EIC.</figcaption></figure>
</div>
</div>
</div>
<p>All chromatographic peaks for this region were grouped into a single region. We thus proceed and use these settings for the correspondence analysis of the full data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' perform correspondence analysis on the full data set</span></span>
<span><span class="va">mse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/groupChromPeaks.html" class="external-link">groupChromPeaks</a></span><span class="op">(</span><span class="va">mse</span>, param <span class="op">=</span> <span class="va">pdp</span><span class="op">)</span></span></code></pre></div>
</div>
<p>It is advised to check the results again after correspondence analysis, also to evaluate the impact of the other settings like <code>binSize</code> and <code>ppm</code> and assure validity of the defined LC-MS features. Ideally, a larger number of EICs/features should be checked. We below extract the first example EIC again and evaluate the correspondence results for it. Here it is important to set <code>simulate = FALSE</code> to show the actual results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eic_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">chromatogram</a></span><span class="op">(</span><span class="va">mse</span>, rt <span class="op">=</span> <span class="va">rtr_1</span>, mz <span class="op">=</span> <span class="va">mzr_1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' plot the actual correspondence results by setting `simulate = FALSE`</span></span>
<span><span class="va">col_peak</span> <span class="op">&lt;-</span> <span class="va">col_sample</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-class.html" class="external-link">chromPeaks</a></span><span class="op">(</span><span class="va">eic_1</span><span class="op">)</span><span class="op">[</span>, <span class="st">"sample"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/plotChromPeakDensity.html" class="external-link">plotChromPeakDensity</a></span><span class="op">(</span><span class="va">eic_1</span>, col <span class="op">=</span> <span class="va">col_sample</span>, peakCol <span class="op">=</span> <span class="va">col_peak</span>,</span>
<span>                     peakBg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_peak</span>, <span class="fl">40</span><span class="op">)</span>,</span>
<span>                     simulate <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-43-1.png" width="672"></p>
<figcaption>Correspondence results for the first example EIC.</figcaption></figure>
</div>
</div>
</div>
<p>All chromatographic peaks were grouped into the same feature. The retention time (<code>"rtmed"</code>) of the feature is indicated with a dashed vertical line. We next evaluate the results also on the second example EIC.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eic_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">chromatogram</a></span><span class="op">(</span><span class="va">mse</span>, rt <span class="op">=</span> <span class="va">rtr_2</span>, mz <span class="op">=</span> <span class="va">mzr_2</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' plot the actual correspondence results by setting `simulate = FALSE`</span></span>
<span><span class="va">col_peak</span> <span class="op">&lt;-</span> <span class="va">col_sample</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-class.html" class="external-link">chromPeaks</a></span><span class="op">(</span><span class="va">eic_2</span><span class="op">)</span><span class="op">[</span>, <span class="st">"sample"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/plotChromPeakDensity.html" class="external-link">plotChromPeakDensity</a></span><span class="op">(</span><span class="va">eic_2</span>, col <span class="op">=</span> <span class="va">col_sample</span>, peakCol <span class="op">=</span> <span class="va">col_peak</span>,</span>
<span>                     peakBg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_peak</span>, <span class="fl">40</span><span class="op">)</span>,</span>
<span>                     simulate <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-44-1.png" width="672"></p>
<figcaption>Correspondence results for the second example EIC.</figcaption></figure>
</div>
</div>
</div>
<p>Also for this retention time region, chromatographic peaks were grouped into a single feature. At last we evaluate the expanded retention time region of the <em>m/z</em> range of the first example EIC.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">chromatogram</a></span><span class="op">(</span><span class="va">mse</span>, mz <span class="op">=</span> <span class="va">mzr_1</span>, rt <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">30</span>, <span class="fl">150</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">col_peak</span> <span class="op">&lt;-</span> <span class="va">col_sample</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-class.html" class="external-link">chromPeaks</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span><span class="op">[</span>, <span class="st">"sample"</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/plotChromPeakDensity.html" class="external-link">plotChromPeakDensity</a></span><span class="op">(</span><span class="va">a</span>, col <span class="op">=</span> <span class="va">col_sample</span>, peakCol <span class="op">=</span> <span class="va">col_peak</span>,</span>
<span>                     peakBg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">col_peak</span>, <span class="fl">40</span><span class="op">)</span>,</span>
<span>                     simulate <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-45-1.png" width="672"></p>
<figcaption>Correspondence results for an <em>m/z</em> slice with multiple closely eluting compounds.</figcaption></figure>
</div>
</div>
</div>
<p>For this region, chromatographic peaks were grouped into 3 distinct features.</p>
<p>The results from the correspondence analysis can be extracted from the result object using the <code><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-class.html" class="external-link">featureDefinitions()</a></code> and <code><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-peak-grouping-results.html" class="external-link">featureValues()</a></code> functions. The former returns the <em>definition</em> of the LC-MS features, i.e., their <em>m/z</em> and retention time, the latter the actual abundance estimates in the different samples. We below count the number of features that were defined by the correspondence analysis:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-class.html" class="external-link">featureDefinitions</a></span><span class="op">(</span><span class="va">mse</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 14808</code></pre>
</div>
</div>
<p>A quite large number of features was defined. This is mostly due to the setting for the <code>minFraction</code> parameter, which required a chromatographic peak to be detected in only 2 out of the 3 replicates for each individual sample to define, and combine them into, a feature.</p>
<p>We can now extract the abundance estimates of all features with the <code><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-peak-grouping-results.html" class="external-link">featureValues()</a></code> function. Below we extract this data matrix and assign the unique sample name as column names (by default the MS data file name is used).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fvals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-peak-grouping-results.html" class="external-link">featureValues</a></span><span class="op">(</span><span class="va">mse</span>, method <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">fvals</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MsExperiment/man/MsExperiment.html" class="external-link">sampleData</a></span><span class="op">(</span><span class="va">mse</span><span class="op">)</span><span class="op">$</span><span class="va">sample_desc</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">fvals</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>        A15M_R1 A15M_R2 A15M_R3  A45M_R1 A45M_R2 A45M_R3  A5M_R1 A5M_R2 A5M_R3
FT00001      NA      NA      NA       NA      NA      NA      NA     NA     NA
FT00002      NA      NA      NA       NA      NA      NA      NA     NA     NA
FT00003      NA      NA      NA       NA      NA      NA      NA     NA     NA
FT00004      NA 3392535      NA 10258668      NA 9478585 5519297     NA     NA
FT00005      NA      NA      NA  9521460      NA 6722026 2419544     NA     NA
FT00006      NA      NA      NA  4874998      NA 5897690 3338828     NA     NA
           M_R1 M_R2 M_R3    PPL_R1
FT00001      NA   NA   NA  127518.4
FT00002      NA   NA   NA  201678.3
FT00003      NA   NA   NA  502676.9
FT00004 3684237   NA   NA 6198111.3
FT00005 3405333   NA   NA 2953772.8
FT00006      NA   NA   NA 6931111.8</code></pre>
</div>
</div>
<p>Columns in this abundance matrix are samples, rows features. For the present data set there are a large number of missing values. A missing value indicates failure to detect a chromatographic peak for the <em>m/z</em> - retention time region of a feature in a sample. This can have multiple reasons: the compound might simply not be present in the sample or the original signal is too noisy, to low in abundance, or does not fit the expected shape for the peak detection algorithm to identify a chromatographic peak.</p>
<p>Below we calculate and plot the number of missing values per sample.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' determine the number of missing values per sample and plot them</span></span>
<span><span class="va">nas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">fvals</span>, MARGIN <span class="op">=</span> <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html" class="external-link">barplot</a></span><span class="op">(</span><span class="va">nas</span>, main <span class="op">=</span> <span class="st">"Number of missing values"</span>, col <span class="op">=</span> <span class="va">col_sample</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-48-1.png" width="672"></p>
<figcaption>Number of missing feature values per sample.</figcaption></figure>
</div>
</div>
</div>
<p>The lowest number of missing values is present in the <em>PPL_R1</em> sample.</p>
</section><section class="level2"><h3 id="gap-filling">Gap-filling<a class="anchor" aria-label="anchor" href="#gap-filling"></a>
</h3>
<p>To reduce the number of missing values and avoid data imputation we perform <em>gap-filling</em>: in samples with a missing value for a feature (i.e., in which no chromatographic peak was detected) we integrate all intensities measured within the <em>m/z</em> - retention time area of the feature. By default, this area is defined as the 25% to 75% quantile of the lower, respectively upper <em>m/z</em> (and retention time) boundary of all chromatographic peaks of a feature. As an example we calculate this area with the <code><a href="https://rdrr.io/pkg/xcms/man/XcmsExperiment.html" class="external-link">featureArea()</a></code> function for the first 6 features:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XcmsExperiment.html" class="external-link">featureArea</a></span><span class="op">(</span><span class="va">mse</span>,</span>
<span>            mzmin <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">z</span>, probs <span class="op">=</span> <span class="fl">0.25</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            mzmax <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">z</span>, probs <span class="op">=</span> <span class="fl">0.75</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            rtmin <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">z</span>, probs <span class="op">=</span> <span class="fl">0.25</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            rtmax <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">z</span>, probs <span class="op">=</span> <span class="fl">0.75</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-class.html" class="external-link">featureDefinitions</a></span><span class="op">(</span><span class="va">mse</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           mzmin    mzmax    rtmin    rtmax
FT00001 150.0268 150.0270 588.3672 594.2322
FT00002 150.0789 150.0791 166.7511 175.2998
FT00003 150.0912 150.0916 245.4199 254.4996
FT00004 150.1022 150.1030 812.2422 837.7419</code></pre>
</div>
</div>
<p>Thus, for gap-filling, missing values are replaced with the integrated signal measured by the MS instrument within these <em>m/z</em> - retention time boundaries.</p>
<p>We below perform the gap-filling on the full data set.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' configure and perform gap-filling</span></span>
<span><span class="va">cpap</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/fillChromPeaks.html" class="external-link">ChromPeakAreaParam</a></span><span class="op">(</span>minMzWidthPpm <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">mse</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/fillChromPeaks.html" class="external-link">fillChromPeaks</a></span><span class="op">(</span><span class="va">mse</span>, param <span class="op">=</span> <span class="va">cpap</span>, chunkSize <span class="op">=</span> <span class="fl">4L</span><span class="op">)</span></span></code></pre></div>
</div>
<p>We extract the feature values again and determine the number of missing values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fvals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-peak-grouping-results.html" class="external-link">featureValues</a></span><span class="op">(</span><span class="va">mse</span>, method <span class="op">=</span> <span class="st">"sum"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">fvals</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/MsExperiment/man/MsExperiment.html" class="external-link">sampleData</a></span><span class="op">(</span><span class="va">mse</span><span class="op">)</span><span class="op">$</span><span class="va">sample_desc</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">fvals</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          A15M_R1   A15M_R2    A15M_R3  A45M_R1   A45M_R2   A45M_R3    A5M_R1
FT00001        NA        NA         NA       NA        NA        NA        NA
FT00002        NA        NA         NA       NA        NA        NA        NA
FT00003  725629.5  395193.8   609652.6   709672  712048.4  325696.1  582689.3
FT00004 6667479.8 3392535.0 10874295.1 10258668 9681633.2 9478584.9 5519297.2
FT00005 4424076.9 5594730.1  8961144.0  9521460 7483711.7 6722025.8 2419544.4
FT00006 5058937.4 6075048.7  8164059.6  4874998 7531471.2 5897690.0 3338828.4
            A5M_R2  A5M_R3      M_R1    M_R2      M_R3    PPL_R1
FT00001         NA      NA   56655.1      NA        NA  127518.4
FT00002         NA      NA        NA      NA        NA  201678.3
FT00003   737115.2  653138  470292.9  357432  463980.4  502676.9
FT00004 10336613.6 6591140 3684237.3 6720029 8384267.6 6198111.3
FT00005 10403154.3 5371937 3405332.8 5232400 8119441.8 2953772.8
FT00006  7827918.6 6753662 5360799.4 4505007 7968544.6 6931111.8</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' determine the number of missing values per sample and plot them</span></span>
<span><span class="va">nas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">fvals</span>, MARGIN <span class="op">=</span> <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">z</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/barplot.html" class="external-link">barplot</a></span><span class="op">(</span><span class="va">nas</span>, main <span class="op">=</span> <span class="st">"Number of missing values"</span>, col <span class="op">=</span> <span class="va">col_sample</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-52-1.png" width="672"></p>
<figcaption>Number of missing feature values per sample after gap-filling.</figcaption></figure>
</div>
</div>
</div>
<p>A considerable amount of values could thus be <em>rescued</em>.</p>
</section></section><section class="section level2"><h2 id="extract-fragment-spectra-for-lc-ms-features">Extract fragment spectra for LC-MS features<a class="anchor" aria-label="anchor" href="#extract-fragment-spectra-for-lc-ms-features"></a>
</h2>
<p>After preprocessing, we next identify and extract the MS2 spectra for the defined LC-MS features. We use the <code><a href="https://rdrr.io/pkg/xcms/man/featureSpectra.html" class="external-link">featureSpectra()</a></code> method, that identifies for each of the features’ chromatographic peaks MS2 spectra (within the same sample!) with their retention time and precursor <em>m/z</em> within the retention time and <em>m/z</em> range of the chromatographic peak.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' identify MS2 spectra for features</span></span>
<span><span class="va">ms2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/featureSpectra.html" class="external-link">featureSpectra</a></span><span class="op">(</span><span class="va">mse</span><span class="op">)</span></span>
<span><span class="va">ms2</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MSn data (Spectra) with 21917 spectra in a MsBackendMzR backend:
        msLevel     rtime scanIndex
      &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
1             2   169.361       834
2             2   169.909       837
3             2   170.225       844
4             2   169.786       845
5             2   169.721       844
...         ...       ...       ...
21913         2   748.486      3747
21914         2   747.600      3748
21915         2   744.174      3679
21916         2   748.223      3744
21917         2   749.801      3791
 ... 40 more variables/columns.

file(s):
Interlab-LC-MS_Lab2_A15M_Pos_MS2_Rep2.mzML
Interlab-LC-MS_Lab2_A15M_Pos_MS2_Rep3.mzML
Interlab-LC-MS_Lab2_A45M_Pos_MS2_Rep1.mzML
 ... 10 more files
Processing:
 Filter: select retention time [20..850] on MS level(s)  [Wed Nov 26 15:59:31 2025]
 Filter: select MS level(s) 2 [Wed Nov 26 16:05:30 2025]
 Filter: select MS level(s) 2 [Wed Nov 26 16:05:31 2025]
 ...2 more processings. Use 'processingLog' to list all. </code></pre>
</div>
</div>
<p>We can have multiple, or no, MS2 spectra per feature:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' count the number of MS2 spectra per feature</span></span>
<span><span class="va">ms2_count</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">ms2</span><span class="op">$</span><span class="va">feature_id</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' the number of LC-MS features with at least one MS2 spectrum:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ms2_count</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 3091</code></pre>
</div>
<div class="sourceCode cell-code" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' the average number of MS2 spectra per feature:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">ms2_count</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 7.090586</code></pre>
</div>
</div>
<p>We next inspect some of the identified MS2 spectra.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' select MS2 spectra for the first feature</span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="va">ms2</span><span class="op">[</span><span class="va">ms2</span><span class="op">$</span><span class="va">feature_id</span> <span class="op">==</span> <span class="va">ms2</span><span class="op">$</span><span class="va">feature_id</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="co">#' plot the spectra</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html" class="external-link">plotSpectra</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-55-1.png" width="912"></p>
<figcaption>MS2 spectra for one LC-MS feature.</figcaption></figure>
</div>
</div>
</div>
<p>All MS2 spectra look similar - we next calculate also a pairwise similarity between them and visualize the results as a heatmap.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' calculate dot product similarity</span></span>
<span><span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ProtGenerics/man/protgenerics.html" class="external-link">compareSpectra</a></span><span class="op">(</span><span class="va">a</span>, ppm <span class="op">=</span> <span class="fl">10</span>, tolerance <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/pheatmap/man/pheatmap.html" class="external-link">pheatmap</a></span><span class="op">(</span><span class="va">sim</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-56-1.png" width="912"></p>
<figcaption>Pairwise spectra similarity between MS2 spectra of one feature.</figcaption></figure>
</div>
</div>
</div>
<p>Similarity between all MS2 spectra is very high (above 0.92).</p>
<p>We next combine the individual MS2 spectra of a feature to a single <em>consensus</em> spectrum.</p>
<div>
<blockquote>
<p><strong>Options to combine spectra</strong></p>
<p>Multiple spectra can be combined into a single spectrum using the <code><a href="https://rdrr.io/pkg/Spectra/man/combineSpectra.html" class="external-link">combineSpectra()</a></code> function which provides a large number of options and parameters for this task, including the possibility to provide a custom function to combine the fragment peaks. By default (with parameter <code>peaks = "union"</code>), the combined spectrum contains <strong>all</strong> mass peaks of all input spectra. The option <code>peaks = "intersect"</code> allows to retain only peaks that are present in a certain proportion of input spectra. Parameters <code>ppm</code> and <code>tolerance</code> define the required similarity in the peaks’ <em>m/z</em> value to be considered <em>the same</em>. The groups of spectra to be combined are specified with parameter <code>f</code> and a potential splitting of the input <code>Spectra</code> object for parallel processing with parameter <code>p</code>.</p>
</blockquote>
</div>
<p>As an example, we combine MS2 spectra keeping only mass peaks present in at least 75% of input spectra.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' define consensus spectra per feature</span></span>
<span><span class="va">ms2_cons</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/combineSpectra.html" class="external-link">combineSpectra</a></span><span class="op">(</span><span class="va">ms2</span>, f <span class="op">=</span> <span class="va">ms2</span><span class="op">$</span><span class="va">feature_id</span>,</span>
<span>                           p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ms2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                           peaks <span class="op">=</span> <span class="st">"intersect"</span>,</span>
<span>                           ppm <span class="op">=</span> <span class="fl">10</span>, minProp <span class="op">=</span> <span class="fl">0.75</span><span class="op">)</span></span>
<span><span class="va">ms2_cons</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MSn data (Spectra) with 3091 spectra in a MsBackendMemory backend:
       msLevel     rtime scanIndex
     &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
1            2  169.3607       834
2            2  147.8949       725
3            2   35.3421       164
4            2  836.9768      4221
5            2  310.3339      1548
...        ...       ...       ...
3087         2   610.293      3053
3088         2   608.046      3050
3089         2   794.229      3958
3090         2   744.275      3673
3091         2   749.801      3791
 ... 40 more variables/columns.
Processing:
 Filter: select retention time [20..850] on MS level(s)  [Wed Nov 26 15:59:31 2025]
 Filter: select MS level(s) 2 [Wed Nov 26 16:05:30 2025]
 Filter: select MS level(s) 2 [Wed Nov 26 16:05:31 2025]
 ...3 more processings. Use 'processingLog' to list all. </code></pre>
</div>
</div>
<p>We have thus now one consensus spectrum per feature. A summary of the numbers of peaks per consensus spectrum is shown below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' overview on the number of peaks per spectrum</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lengths.html" class="external-link">lengths</a></span><span class="op">(</span><span class="va">ms2_cons</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   0%   25%   50%   75%  100%
  1.0  66.5 102.0 146.0 463.0 </code></pre>
</div>
</div>
<p>The consensus spectrum for the first feature is shown below.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/spectra-plotting.html" class="external-link">plotSpectra</a></span><span class="op">(</span><span class="va">ms2_cons</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-59-1.png" width="672"></p>
<figcaption>Consensus spectrum for the first feature.</figcaption></figure>
</div>
</div>
</div>
<p>We next filter the data and remove spectra with a single fragment peak.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' remove spectra with a single fragment peak</span></span>
<span><span class="va">ms2_cons</span> <span class="op">&lt;-</span> <span class="va">ms2_cons</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lengths.html" class="external-link">lengths</a></span><span class="op">(</span><span class="va">ms2_cons</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">ms2_cons</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>MSn data (Spectra) with 3089 spectra in a MsBackendMemory backend:
       msLevel     rtime scanIndex
     &lt;integer&gt; &lt;numeric&gt; &lt;integer&gt;
1            2  169.3607       834
2            2  147.8949       725
3            2   35.3421       164
4            2  836.9768      4221
5            2  310.3339      1548
...        ...       ...       ...
3085         2   610.293      3053
3086         2   608.046      3050
3087         2   794.229      3958
3088         2   744.275      3673
3089         2   749.801      3791
 ... 40 more variables/columns.
Processing:
 Filter: select retention time [20..850] on MS level(s)  [Wed Nov 26 15:59:31 2025]
 Filter: select MS level(s) 2 [Wed Nov 26 16:05:30 2025]
 Filter: select MS level(s) 2 [Wed Nov 26 16:05:31 2025]
 ...3 more processings. Use 'processingLog' to list all. </code></pre>
</div>
</div>
<div>
<blockquote>
<p><strong>Additional spectra processing options</strong></p>
<p>The <a href="https://bioconductor.org/packages/Spectra" class="external-link"><em>Spectra</em></a> package would provide many additional functions and options to process, scale or clean spectra. As an alternative, through the <a href="https://bioconductor.org/packages/SpectriPy" class="external-link"><em>SpectriPy</em></a> package, it would also be possible to apply Python-based functionality from e.g. the <em>matchms</em> Python library to <code>Spectra</code> objects.</p>
</blockquote>
</div>
<p>At last we visualize the select data (i.e. features with associated MS2 spectra) in the <em>m/z</em> - retention time space. We use the <code><a href="https://rdrr.io/pkg/xcms/man/XcmsExperiment.html" class="external-link">featureArea()</a></code> function to get the feature boundaries and draw them as rectangles. The associated MS2 spectra (their precursor <em>m/z</em> and retention time value) are added as individual data points.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' define the feature boundaries</span></span>
<span><span class="va">fa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XcmsExperiment.html" class="external-link">featureArea</a></span><span class="op">(</span><span class="va">mse</span>, features <span class="op">=</span> <span class="va">ms2_cons</span><span class="op">$</span><span class="va">feature_id</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' plot feature areas as rectangles</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="cn">NA</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">fa</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"rtmin"</span>, <span class="st">"rtmax"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,</span>
<span>     ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="va">fa</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mzmin"</span>, <span class="st">"mzmax"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">"retention time"</span>, ylab <span class="op">=</span> <span class="st">"m/z"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/grid.html" class="external-link">grid</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/rect.html" class="external-link">rect</a></span><span class="op">(</span>xleft <span class="op">=</span> <span class="va">fa</span><span class="op">[</span>, <span class="st">"rtmin"</span><span class="op">]</span>, xright <span class="op">=</span> <span class="va">fa</span><span class="op">[</span>, <span class="st">"rtmax"</span><span class="op">]</span>,</span>
<span>     ybottom <span class="op">=</span> <span class="va">fa</span><span class="op">[</span>, <span class="st">"mzmin"</span><span class="op">]</span>, ytop <span class="op">=</span> <span class="va">fa</span><span class="op">[</span>, <span class="st">"mzmax"</span><span class="op">]</span>,</span>
<span>     border <span class="op">=</span> <span class="st">"#00000080"</span><span class="op">)</span></span>
<span><span class="co">#' add precursor m/z and retention times of MS2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">ms2_cons</span><span class="op">$</span><span class="va">rtime</span>, <span class="va">ms2_cons</span><span class="op">$</span><span class="va">precursorMz</span>,</span>
<span>       cex <span class="op">=</span> <span class="fl">0.5</span>, col <span class="op">=</span> <span class="st">"#0000ff40"</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure><p><img src="MSV000090156-preprocessing_files/figure-html/unnamed-chunk-61-1.png" width="912"></p>
<figcaption>Feature areas (grey rectangles) and associated MS2 spectra (blue points) in the retention time - <em>m/z</em> space.</figcaption></figure>
</div>
</div>
</div>
<p>Thus, with a little bit of R coding we can easily create customized data visualizations.</p>
</section><section class="section level2"><h2 id="formatting-and-exporting-data-for-fbms">Formatting and exporting data for FBMS<a class="anchor" aria-label="anchor" href="#formatting-and-exporting-data-for-fbms"></a>
</h2>
<p>We next export the feature abundance matrix and the fragment spectra for feature-based molecular networking with GNPS. Similar to the original workflow <span class="citation" data-cites="johannes_rainer_2025_17293665">(<a href="#ref-johannes_rainer_2025_17293665" role="doc-biblioref">Rainer and Louail 2025</a>)</span> described in <span class="citation" data-cites="nothias_feature-based_2020">(<a href="#ref-nothias_feature-based_2020" role="doc-biblioref">Nothias et al. 2020</a>)</span> we write the feature matrix to a tabulator delimited text file and the associated MS2 spectra to a file in Mascot Generic File (MGF) format. A future version of the workflow might use the mzTab-M format for the data exchange.</p>
<p>We first compile the feature abundance matrix and export that to a txt file.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' get feature definitions</span></span>
<span><span class="va">fdef</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/xcms/man/XCMSnExp-class.html" class="external-link">featureDefinitions</a></span><span class="op">(</span><span class="va">mse</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mzmin"</span>, <span class="st">"mzmed"</span>, <span class="st">"mzmax"</span>,</span>
<span>                                    <span class="st">"rtmin"</span>, <span class="st">"rtmed"</span>, <span class="st">"rtmax"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#' combine with the feature value table</span></span>
<span><span class="va">fvals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>feature_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">fdef</span><span class="op">)</span>, <span class="va">fdef</span>, <span class="va">fvals</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#' restrict the feature abundance matrix to features with MS2 spectra</span></span>
<span><span class="va">fvals</span> <span class="op">&lt;-</span> <span class="va">fvals</span><span class="op">[</span><span class="va">ms2_cons</span><span class="op">$</span><span class="va">feature_id</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co">#' export the data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.table</a></span><span class="op">(</span><span class="va">fvals</span>, <span class="st">"xcms_ms2_features.txt"</span>, sep <span class="op">=</span> <span class="st">"\t"</span>,</span>
<span>            quote <span class="op">=</span> <span class="cn">FALSE</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
</div>
<p>We next reformat the information in the MS2 spectra restricting to data required by GNPS. The respective functionality is at present provided in the <a href="https://github.com/jorainer/xcms-gnps-tools" class="external-link">xcms-gnps-tools</a> GitHub repo.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' load functions for GNPS-specific spectra formatting</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html" class="external-link">source</a></span><span class="op">(</span><span class="st">"https://raw.githubusercontent.com/jorainer/xcms-gnps-tools/master/customFunctions.R"</span><span class="op">)</span></span>
<span><span class="va">ms2_cons</span> <span class="op">&lt;-</span> <span class="fu">formatSpectraForGNPS</span><span class="op">(</span><span class="va">ms2_cons</span><span class="op">)</span></span></code></pre></div>
</div>
<p>And finally we export the MS2 spectra in MGF format.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' export the MS2 spectra in MGF format</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Spectra/man/Spectra.html" class="external-link">export</a></span><span class="op">(</span><span class="va">ms2_cons</span>, backend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/MsBackendMgf/man/MsBackendMgf.html" class="external-link">MsBackendMgf</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>       file <span class="op">=</span> <span class="st">"xcms_ms2_spectra.mgf"</span><span class="op">)</span></span></code></pre></div>
</div>
<div>
<blockquote>
<p><strong>Spectra data export formats</strong></p>
<p>The MGF format is only loosely defined with many different <em>dialects</em> being used. The <a href="https://bioconductor.org/packages/MsBackendMgf" class="external-link"><em>MsBackendMgf</em></a> package supports renaming or specifying spectra variables (metadata) for export to the MGF format. In addition, it would also allow to export also additional peak information, such as chemical formulas for individual fragments. As an alternative, also other export formats would be supported for <code>Spectra</code> objects, provided by packages such as the <a href="https://bioconductor.org/packages/MsBackendMsp" class="external-link"><em>MsBackendMsp</em></a> or <a href="https://bioconductor.org/packages/MsBackendMassbank" class="external-link"><em>MsBackendMassbank</em></a>. Upcoming formats, such as <em>specLib</em>, <em>mzPeak</em> or the updated mzTab-M format will be supported in future.</p>
</blockquote>
</div>
</section><section class="section level2"><h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<ul>
<li>R-based data analysis workflows allow data set specific, tailored, analysis of LC-MS data.</li>
<li>The <em>xcms</em> R package for LC-MS data preprocessing is tightly integrated into a broader ecosystem of R packages.</li>
<li>The quarto system would also allow combining R and Python functionality into the same workflow document with the <a href="https://github.com/RforMassSpectrometry/SpectriPy" class="external-link">SpectriPy</a> R-package translating between R and Python MS data structures.</li>
</ul></section><section class="section level2"><h2 id="session-information">Session information<a class="anchor" aria-label="anchor" href="#session-information"></a>
</h2>
<p>The R version and package versions used:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.5.2 (2025-10-31)
Platform: x86_64-pc-linux-gnu
Running under: Ubuntu 24.04.3 LTS

Matrix products: default
BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3
LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.26.so;  LAPACK version 3.12.0

locale:
 [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C
 [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8
 [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8
 [7] LC_PAPER=en_US.UTF-8       LC_NAME=C
 [9] LC_ADDRESS=C               LC_TELEPHONE=C
[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C

time zone: Etc/UTC
tzcode source: system (glibc)

attached base packages:
[1] stats4    stats     graphics  grDevices utils     datasets  methods
[8] base

other attached packages:
 [1] vioplot_0.5.1       zoo_1.8-14          sm_2.2-6.0
 [4] pheatmap_1.0.13     pander_0.6.6        RColorBrewer_1.1-3
 [7] MsBackendMgf_1.18.0 xcms_4.8.0          Spectra_1.20.0
[10] BiocParallel_1.44.0 S4Vectors_0.48.0    BiocGenerics_0.56.0
[13] generics_0.1.4      MsExperiment_1.12.0 ProtGenerics_1.42.0

loaded via a namespace (and not attached):
 [1] DBI_1.2.3                   rlang_1.1.6
 [3] magrittr_2.0.4              clue_0.3-66
 [5] MassSpecWavelet_1.76.0      matrixStats_1.5.0
 [7] compiler_4.5.2              vctrs_0.6.5
 [9] reshape2_1.4.5              stringr_1.6.0
[11] pkgconfig_2.0.3             MetaboCoreUtils_1.18.1
[13] crayon_1.5.3                fastmap_1.2.0
[15] XVector_0.50.0              rmarkdown_2.30
[17] preprocessCore_1.72.0       purrr_1.2.0
[19] xfun_0.54                   MultiAssayExperiment_1.36.1
[21] jsonlite_2.0.0              progress_1.2.3
[23] DelayedArray_0.36.0         parallel_4.5.2
[25] prettyunits_1.2.0           cluster_2.1.8.1
[27] R6_2.6.1                    stringi_1.8.7
[29] limma_3.66.0                GenomicRanges_1.62.0
[31] Rcpp_1.1.0                  Seqinfo_1.0.0
[33] SummarizedExperiment_1.40.0 iterators_1.0.14
[35] knitr_1.50                  IRanges_2.44.0
[37] BiocBaseUtils_1.12.0        Matrix_1.7-4
[39] igraph_2.2.1                tidyselect_1.2.1
[41] abind_1.4-8                 yaml_2.3.10
[43] doParallel_1.0.17           codetools_0.2-20
[45] affy_1.88.0                 lattice_0.22-7
[47] tibble_3.3.0                plyr_1.8.9
[49] Biobase_2.70.0              S7_0.2.1
[51] evaluate_1.0.5              pillar_1.11.1
[53] affyio_1.80.0               BiocManager_1.30.27
[55] MatrixGenerics_1.22.0       foreach_1.5.2
[57] MSnbase_2.36.0              MALDIquant_1.22.3
[59] ncdf4_1.24                  hms_1.1.4
[61] ggplot2_4.0.1               scales_1.4.0
[63] glue_1.8.0                  MsFeatures_1.18.0
[65] lazyeval_0.2.2              tools_4.5.2
[67] mzID_1.48.0                 data.table_1.17.8
[69] QFeatures_1.20.0            vsn_3.78.0
[71] mzR_2.44.0                  fs_1.6.6
[73] XML_3.99-0.20               grid_4.5.2
[75] impute_1.84.0               tidyr_1.3.1
[77] MsCoreUtils_1.21.0          PSMatch_1.14.0
[79] cli_3.6.5                   S4Arrays_1.10.0
[81] dplyr_1.1.4                 AnnotationFilter_1.34.0
[83] pcaMethods_2.2.0            gtable_0.3.6
[85] digest_0.6.39               SparseArray_1.10.2
[87] farver_2.1.2                htmltools_0.5.8.1
[89] lifecycle_1.0.4             statmod_1.5.1
[91] MASS_7.3-65                </code></pre>
</div>
</div>
</section><section class="section level2"><h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-louail_xcms_2025" class="csl-entry" role="listitem">
Louail, Philippine, Carl Brunius, Mar Garcia-Aloy, William Kumler, Norman Storz, Jan Stanstrup, Hendrik Treutler, et al. 2025. <span>“Xcms at 20 and Still in Peak Form: <span>Anchoring</span> a Complete Metabolomics Data Preprocessing and Analysis Software Ecosystem.”</span> ChemRxiv. <a href="https://doi.org/10.26434/chemrxiv-2025-2n2kh" class="external-link">https://doi.org/10.26434/chemrxiv-2025-2n2kh</a>.
</div>
<div id="ref-louail_rformassspectrometrymetabonaut_2025" class="csl-entry" role="listitem">
Louail, Philippine, Marilyn De Graeve, Anna Tagliaferri, Vinicius Verri Hernandes, Daniel Marques de Sá e Silva, and Johannes Rainer. 2025. <span>“Rformassspectrometry/<span>Metabonaut</span>: V1.2.0.”</span> Zenodo. <a href="https://doi.org/10.5281/zenodo.15554287" class="external-link">https://doi.org/10.5281/zenodo.15554287</a>.
</div>
<div id="ref-nothias_feature-based_2020" class="csl-entry" role="listitem">
Nothias, Louis-Félix, Daniel Petras, Robin Schmid, Kai Dührkop, Johannes Rainer, Abinesh Sarvepalli, Ivan Protsyuk, et al. 2020. <span>“Feature-Based Molecular Networking in the <span>GNPS</span> Analysis Environment.”</span> <em>Nature Methods</em> 17 (9): 905–8. <a href="https://doi.org/10.1038/s41592-020-0933-6" class="external-link">https://doi.org/10.1038/s41592-020-0933-6</a>.
</div>
<div id="ref-johannes_rainer_2025_17293665" class="csl-entry" role="listitem">
Rainer, Johannes, and Philippine Louail. 2025. <span>“Jorainer/Xcms-Gnps-Large-Scale: Preprocessing of a Large LC-MS/MS Data Set for Molecular Networking with GNPS.”</span> Zenodo. <a href="https://doi.org/10.5281/zenodo.17293665" class="external-link">https://doi.org/10.5281/zenodo.17293665</a>.
</div>
</div>
</section><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'light-border',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config);
    }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script></main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Philippine Louail, Johannes Rainer.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.9000.</p>
</div>

    </footer>
</div>





  </body>
</html>
